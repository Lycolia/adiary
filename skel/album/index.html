<@6>
<$ifsuperjump_clear(! Auth.ok, '_sub/error_message_403', 'ログインしていません')>
<$ifsuperjump_clear(! v.allow_edit, '_sub/error_message_403', 'ブログが存在しないか権限がありません')>

<@> システムモード
<$v.system_mode("画像アルバム")>

<@> 階層ツリー
<@call("_dir_tree")>

<!--========================================================================-->
<$v.special_sidebar_module = 'album/_sidebar'>
<$v.init_image_dir()>

<$v.regist_css  ("<@v.script_dir>dynatree/skin/ui.dynatree.css")>
<$v.regist_jslib("<@v.script_dir>jquery.cookie.js")>
<$v.regist_jslib("<@v.script_dir>dynatree/jquery.dynatree.min.js")>
<$v.regist_js   ("<@v.script_dir>album.js")>

<article class="system" id="album">
<h2 class="dynatree-ico-ef"><span id="folder-icon"></span><span id="current-folder">(no load)</span></h2>
<div class="body">
	<div id="album-header">
		<div>
			操作方法<span class="help" data-help="クリック：選択\nダブルクリック：表示\nCTRL+クリック：ダウンロード\nCTRL+記事に : 改行せずに貼り付け">?</span>
			<input type="checkbox" id="all-select"><label>全選択</label>
		</div>
		<div class="view-option">
			<span class="option-item">最大サイズ
			<select id="thumb-maxsize" class="r js-save">
				<option value=" 60"> 60px</option>
				<option value=" 80"> 80px</option>
				<option value="100">100px</option>
				<option value="120" selected>120px</option>
				<option value="160">160px</option>
				<option value="200">200px</option>
				<option value="240">240px</option>
			</select><span class="help" data-help="サムネイルの表示最大サイズを指定します。指定サイズより小さいサムネイルはそのままです。\n※IE8以前では動作しません。">?</span>
			</span>
			<select id="view-type">
				<option value="thumb">サムネイル</option>
				<option value="name">ファイル名</option>
			</select>
			<span class="option-item">ソート
			<select id="sort-type">
				<option value="name">名前</option>
				<option value="date">日付</option>
				<option value="size">サイズ</option>
			</select>
			<select id="sort-rev">
				<option value="0">昇順</option>
				<option value="1">降順</option>
			</select></span>
		</div>
	</div>

	<div id="album-folder-view"></div>

	<h4 id="selected-files-title"><input type="checkbox" class="js-switch" data-target="#selected-files"><label>選択中のファイル名を表示</label><span class="help" data-help="ファイル名を変更するには「選択ファイル名の表示」から該当ファイルをダブルクリックしてください。">?</span></h4>
	<ul id="selected-files"></ul>

	<form action="<@v.myself>?edit" method="POST" id="paste-form" data-tag="[file:%e:%d:%f:%f]">
	<input type="hidden" name="action" value="etc/dummy">
	<input type="hidden" name="csrf_check_key" value="<@CSRF_check_key>">
	<input type="hidden" name="paste_txt" value="" id="paste-txt">
	<button type="submit" id="paste-thumbnail" data-tag="[image:S:%d:%f:%f]">サムネイルを記事に</button>
	<button type="submit" id="paste-original"  data-tag="[image:L:%d:%f:%f]">元画像を記事に</button>
	<button type="button" id="remake-thumbnail">サムネイル再生成</button><span class="help" data-help="選択した画像のサムネイルを、下で指定したサイズで再生成します。「Exifの削除」がチェックされていれば、同時にExif削除も行います。">?</span>
	<button type="button" id="select-exifjpeg">Exif検索</button><span class="help" data-help="Exif情報を持つJPEGファイルを選択します。">?</span>
	</form>

	<@> Ajax用基本データ
	<form action="<@v.myself>?<@v.skeleton>" method="POST" id="album-form" data-myself="<@v.myself>">
	<input type="hidden" name="action" value="<@v.skel_dir>" id="action-base">
	<input type="hidden" name="csrf_check_key" value="<@CSRF_check_key>" id="csrf-key">
	</form>

	<section>
	<!--========================================================================-->
	<h3>アップロード<span class="help" data-help="ドラッグ＆ドロップでアップロードファイルを選択できます（IE9以前や古いブラウザを除く）。\nまた、ファイルダイアログでは対応していれば複数のファイルを選択できます。">?</span></h3>

	<div class="messages" id="upload-messages" style="display: none;"><@join("\n", Message)></div>

	<form action="<@v.myself>?etc/ajax_dummy" method="POST" enctype="multipart/form-data" id="upload-form" target="form_response">
	<input type="hidden" name="action" value="<@v.skel_dir>upload_form">
	<input type="hidden" name="csrf_check_key" value="<@CSRF_check_key>">
	<input type="hidden" name="folder" value="" id="upload-folder">
	<div id="dnd-files"></div><div id="file-elements"><input type="file" name="file0_ary" multiple id="file"></div>
	<button type="submit" id="upload">upload</button><button type="reset" id="upload-reset">リセット</button>
	&nbsp;サムネイル：<input type="number" name="size" value="120" class="w50 js-save" min="64" max="800" id="thumbnail-size">px<br>
	<span id="auto-upload-box"><input type="checkbox" id="auto-upload" class="js-save"><label>自動アップロード</label></span>
	<span id="delete-exif-box"><input type="checkbox" id="delete-exif" class="js-save" name="del_exif" value="1"><label>Exifの削除</label><span class="help" data-help="アップロード時、JPEG画像に含まれるExifなどの情報を削除します。またサムネイル再生成時にもExif削除を行えます。">?</span></span>
	</form>
	</section>

	<!-- 許可拡張子 -->
	<section id="upload-infomation">
	<div>最大サイズ : <@(v.uplaod_files_max>>20)>MB<span class="help" data-help="一回のアプロードできる、全ファイル合計のサイズです。">?</span></div>
	<div>画像拡張子 : <@join(' ', sort_str(keys(v.album_image_ext)))></div>
	<$call('album/_load_extensions')>
	<$x = copy(v.album_allow_ext)><$delete(x.('.'))>
	<div>許可拡張子 : <@join(' ', sort_str(keys(x)))></div>
	</section>
</div>
</article>

<iframe name="form_response" id="form-response" frameborder="0" allowTransparency="true"
 style="width: 100%; height: 80px; overflow-y: scroll; overflow-x:visible; display: none;"></iframe>


<div style="display:none">
<span id="msg-trashbox">ゴミ箱</span>
<span id="image-path"><@Basepath><@v.blogimg_dir()></span>
<span id="icon-path"><@Basepath><@v.album_icons></span>
<span id="uploading-msg">Now uploading</span>

<span id="msg-load-error">画像フォルダが存在しないか情報をロードできません。</span>
<span id="msg-fail-reload">リロードに失敗しました。</span>
<span id="msg-fail-remake">再生成に失敗しました。</span>
<span id="msg-fail-rename-folder">フォルダ名の変更に失敗しました。</span>
<span id="msg-fail-rename-file">ファイル名の変更に失敗しました</span>
<span id="msg-fail-create">フォルダの作成に失敗しました。</span>
<span id="msg-confirm-trash">ゴミ箱を空を空にしますか？</span>
<span id="msg-fail-mv-files">ファイルの移動に失敗しました（移動先に同じファイル名がありませんか？）%f</span>
<span id="msg-fail-mv-folder">フォルダの移動に失敗しました（移動先に同じフォルダ名がありませんか？）%f</span>
<span id="msg-exif-notfound">Exif情報を持つJPEGファイルはありません。</span>
<span id="msg-load-exif-error">Exif画像の検索に失敗しました。</span>
</div>
