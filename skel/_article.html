<@>$HEADER$--------------------------------------------------------------------
<@6>
<@local(ret,s,t,t2,c,permalink,x,node,ps)>
<$s = v.blog>

<@> アップデート警告
<@ifcall(v.skel_dir ne 'design/' &&  v.require_update, '_sub/require_update')>

<$ifexec(argv#0, begin, begin)>
	<$t   = argv#0>
	<$ret = argv#1>
	<$art_year = t.year>
	<$art_mon  = t.mon>
	<$art_day  = t.day>
<$else>
	<$(t,ret) = v.load_article_current_blog(if(v.pinfo ne '', v.pinfo, s.frontpage))>
	<$ifset(v.pinfo eq '', frontpage, 1)>
	<$art_year = ret.year>
	<$art_mon  = ret.mon>
	<$art_day  = ret.day>
<$end>
<$v.title = s.blog_name>

<@ifexec(!v.blogid, begin)>
	<$ifmessage(v.path_blogid, "ブログ <@v.path_blogid> が存在しません", "ブログが指定されていません")>
	<$ifmessage(v.path_blogid && ! Auth.ok, "もしあなたが「ID:<@v.path_blogid>」ならばログインしてください。")>
<$end>
<$ifexec(v.blogid && !t, begin)>
	<$message("該当する記事がありません")>
<$end>
<$ifjump_clear(!t || @Message, "_sub/error_message_404")>

<@>記事タイトル
<$ifset(frontpage, v.subtitle, s.fp_title, t.title)>

<@>$HEADER:END$----------------------------------------------------------------

<@><!--========================================================================-->
<$node = if(t.ctype, v.load_content_node(t.pkey), v.load_art_node(t.pkey))>
<@ifexec(node.prev || node.next || node.upnode || page_nav_force, begin.page)>
<nav class="page-head page-nav" data-module-name="dem_page-nav,1">
<@page_nav = page_nav_force || exec(begin.function)>
<@ifexec(node.prev && node.prev != node.upnode, begin)>
<a href="<@v.myself2><@if(node.prev.link_key, node.prev.elink_key, "0<@node.prev.pkey>")>" class="prev-page pnavi" rel="prev"><@node.prev.title></a>
<$end>
<@ifexec(node.upnode, begin)>
<a href="<@v.myself2><@node.upnode.elink_key>" class="upnode-page pnavi"><@node.upnode.title></a>
<$end>
<@ifexec(node.next, begin)>
<a href="<@v.myself2><@if(node.next.link_key, node.next.elink_key, "0<@node.next.pkey>")>" class="next-page pnavi" rel="next"><@node.next.title></a>
<$end>
<$end.function>
</nav>
<$end.page>
<@>$ARTICLE$-------------------------------------------------------------------
<@>$ARTICLE_TOP$---------------------------------------------------------------

<!--========================================================================-->
<$permalink = if(t.link_key eq s.frontpage, v.myself, "<@v.myself2><@t.elink_key>")>
<$url=v.server_url . permalink>
<$canonical_url = url>
<$encode_uricom(url)>
<@>
<article id="article" class="article<@if(t.priority, " wiki")><@if(t.ctype, " art-<@t.ctype>")>">
<div class="article-body" id="article-body">
<h2 id="art-<@t.pkey>"><@if(!t.priority, #'<a class="date" href="<@permalink>"><span class="y"><@t.year></span><span class="sep">/</span><span class="m"><@t.mon></span><span class="sep">/</span><span class="d"><@t.day></span><span class="wd">(<@t.wday_name>)</span></a>')><a href="<@permalink>" class="title"><@t.title></a></h2>
<div class="body" id="s<@t.pkey>">
<div class="body-header">
<@>$ARTICLE_TOP:END$-----------------------------------------------------------
	<div class="art-info" data-module-name="dea_art-info" data-fix="1">
		<@ifexec(v.check_editor(t), begin)><a href="<@v.myself2>0<@t.pkey>?edit" class="edit-article">（編集）</a><$end>
	</div>
<@>$ARTICLE_MIDDLE$------------------------------------------------------------
</div>
<div class="body-main">
	<@if( t.draft,  '<strong class="warning">【この記事は下書きです】</strong><br>' )>
	<@if(!t.draft && !t.enable, '<strong class="warning">【この記事は非公開です】</strong><br>')>
<@t.text>
	<@ifexec(t.ctype eq 'link', begin)>
	<$x=esc(t.link_key)><p class="link"><a href="<@x>"><@x></a></p>
	<$end>
</div><!-- body-main -->
<div class="body-footer">
<@>$ARTICLE_MIDDLE:END$--------------------------------------------------------
<@>記事リスト・関連記事
<div data-module-name="dea_node-list">
<@ifexec(node.children, begin)>
<h3>記事リスト</h3>
<ul class="art-list art-children">
<@forexec(t2, node.children, begin)>
	<li><a href="<@v.myself2><@t2.elink_key>"><@t2.title></a></li>
<$end>
</ul>
<$end>
<@ifexec(!node.children && node.family, begin)>
<h3>関連記事</h3>
<ul class="art-list art-family">
<@forexec(t2, load_from_ary(node.family, 5), begin)>
	<li><a href="<@v.myself2><@t2.elink_key>"><@t2.title></a></li>
<$end>
</ul>
<$end>
</div>
<@>$ARTICLE_BOTTOM$------------------------------------------------------------
</div> <!-- body-footer -->
</div> <!-- body -->
</div> <!-- article-body -->
<@>$ARTICLE_BOTTOM:END$--------------------------------------------------------

<@>$COMMENT_TOP$---------------------------------------------------------------
<$coms = if(v.allow_edit, t.coms_all, t.coms)>
<@ifexec(t.com_ok || coms, begin)>
<$view = if(Query.c ne 'all', s.view_coms || 20)>
<$secure_id  = make_secure_id( v.blogid . t.pkey )>
<$secure_ary = string2ordary( secure_id )>
<aside class="comment" id="com">
	<div class="caption js-switch" data-target="#c<@t.pkey>n-block"><span class="caption-title">コメント</span><span class="com-num">（<span class="num"><@coms></span>件）</span>
	<@ifexec(view && view<coms, begin)>
	<span class="abbr-msg"><a href="<@permalink>?&amp;c=all#com">※古いコメントもすべて表示</a></span>
	<$end>
	</div>
	<div class="commentbody" id="c<@t.pkey>n-block">
	<@ifexec(coms && v.allow_edit, begin)>
	<div class="comemntview">
	<form method="POST" action="<@permalink>" class="js-form-check" data-target="#com .pkey-ary">
	<input type="hidden" name="action" value="comments_edit">
	<input type="hidden" name="csrf_check_key" value="<@CSRF_check_key>">
	<div class="swiches">
	<input type="checkbox" name="view_ip_host_agent" class="js-switch" data-target="#com div.ip-host-agent"><label>投稿者情報の表示</label>
	<input type="checkbox" name="all_select" class="js-checked" data-target="#com .pkey-ary"><label>すべて選択</label>
	</div>
	<$end>
	<@forexec(c, v.load_comments_current_blog(t, view), begin)>
	<div class="comment-one<@if(!c.enable, ' hidden')>" id="c<@c.num>">
		<div class="commentator">
			<span class="canchor"><a href="#c<@c.num>"><@c.num></a>:</span>	<@\>
			<@ifexec(v.allow_edit, begin)>	<@\>
			<input class="pkey-ary" type="checkbox" name="pkey_int_ary" value="<@c.pkey>">	<@\>
			<label>	<@\>
			<$end>
			<span class="commentator author<@if(c.id, " login-user")>"<@if(c.id, " title=<@c.id>")>><@ifexec(c.email && v.allow_edit, begin, begin)><a href="mailto:<@c.email>"><@c.name></a><$else><@c.name><$end></span>
			<@ifexec(c.url, begin)><span class="comment-url"><a href="<@c.url>" rel="nofollow">URL</a></span><$end>
			<span class="comment-date"><@tm_printf('%Y年%m月%d日(%a) %p%i時%M分', c.tm)></span>
			<@ifexec(!c.enable, begin)>
			<@if(c.hidden, '<strong class="comment-hidden">（非公開コメント）', '<strong class="comment-disable">（非表示）')></strong>
			<$end>
			<@if(v.allow_edit, '</label>')>
		</div>
	
		<div class="comment-text<@if(!c.enable, if(c.hidden, ' comment-hidden', ' comment-disable'))>"><@c.text></div>
		<@ifexec(v.allow_edit, begin)>
		<div class="ip-host-agent"><@c.host> (<@c.ip>)<br><@c.agent></div>
		<$end>
		</div> <!-- comment-one -->
	<$end>
	<@ifexec(coms && v.allow_edit, begin)>
	<div class="com-buttons">
	<@ifexec(t.enable, begin)>
	<input type="submit" name="enable"  class="js-form-check" data-confirm="" value="表示に設定"><span class="help" data-help="非公開コメントを表示することはできません">?</span>
	<input type="submit" name="disable" class="js-form-check" data-confirm="" value="非表示に設定">
	<$end>
	<input type="submit" name="delete"  class="js-form-check" id="del-submit" value="削除" data-confirm="%c件のコメントを削除しますか？">
	<input type="checkbox" name="del_check" class="js-enable" data-target="#del-submit"><label>削除確認</label>
	</div>
	</form>
	<@if(t.com_ok && v.allow_com, '<hr id="com-form-separator">')>
	</div><!-- end of comemntview -->
	<$end>
<@>$COMMENT_TOP:END$-----------------------------------------------------------

	<@ifexec(t.com_ok && v.allow_com, begin)>
	<form method="POST" action="<@permalink>" class="comment" onsubmit="put_sid('sid<@t.pkey>',74, <@\>
	<@forexec(c, secure_ary, begin)><@c ^ 93>,<@c>,<$end> <@\>
	20); return true;" data-module-name="dec_comment-form" data-fix="1">
		<input type="hidden" name="action" value="comment_post">
		<@if(Auth.ok, #'\t\t<input type="hidden" name="csrf_check_key" value="<@CSRF_check_key>">\n')>
		<input type="hidden" name="a_pkey" value="<@t.pkey>">
		<input type="hidden" name="secure_id" value="" id="sid<@t.pkey>">
		<span class="caption-name">名前</span><span class="separater">:</span>
		<@ifexec(Auth.ok, begin, begin)><span class="comment-author"><@Auth.name></span><$else><input type="text" name="name" class="w160 comment-author" value="<@esc(Form.name)>" required><$end>
		<@if(t.hcom_ok, '&emsp;<input type="checkbox" name="hidden" value="1"><label>非公開コメント</label>')>
		<input type="submit" name="post" id="post-comment" value="投稿"><br>
		<textarea class="comment-txt w600" name="comment_txt" rows="3" required><@esc(Form.comment_txt)></textarea>
	</form> <!-- comment form -->
	<$end>
<@>$COMMENT_BOTTOM$------------------------------------------------------------
	</div> <!-- commentbody -->
</aside> <!-- comment -->
<$end>
</article>
<@>$COMMENT_BOTTOM:END$--------------------------------------------------------
<@>$ARTICLE:END$---------------------------------------------------------------


<@ifexec(page_nav, begin.page)>
<nav class="page-foot page-nav" data-module-name="dem_page-nav,2">
<@page_nav>
</nav>
<$end.page>

<@>$FOOTER$--------------------------------------------------------------------
