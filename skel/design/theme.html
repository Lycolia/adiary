<@6>
<@local(s,tp,t)>
<$s = v.blog>
<$ifredirect(!v.blog_admin, v.myself)>
<$v.frame_skeleton=''>
<!--========================================================================-->
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="adiary <@v.VERSION><@v.SUBVERSION>">
<!--[if lt IE 9]>
<script src="<@Basepath><@v.script_dir>jquery-1.min.js"></script>
<script src="<@Basepath><@v.script_dir>IE9-2.1b4.js"></script>
<![endif]-->
<!--[if gte IE 9]><!-->
<script src="<@Basepath><@v.script_dir>jquery-2.min.js"></script>
<!--<![endif]-->
<script src="<@Basepath><@v.script_dir>jquery-ui.min.js"></script>
<script src="<@Basepath><@v.script_dir>adiary.js"></script>
<link rel="stylesheet" media="all" href="<@Basepath><@v.theme_dir>_jquery-ui/jquery-ui.notheme.css" id="jquery-ui-css">
<link rel="stylesheet" media="all" href="<@Basepath><@v.theme_dir>satsuki2/base.css" id="base-css">
<link rel="stylesheet" media="all" href="<@Basepath><@v.theme_dir>satsuki2/satsuki2/satsuki2.css" id="theme">

	<title>テーマ選択 - <@s.blog_name></title>
<!--========================================================================-->
<style>
* {
	margin:		0;
	padding:	0;
}
html, #body {
	height:		100%;
	overflow:	hidden;
<@ifexec(!Develop, begin)>
	overflow:	hidden;
<$end>
}
#body {
	background-color:	#008;
	font-size:		11pt;
}
#back-btn {
	position:		absolute;
	top:			2px;
	right:			4px;
}
#form {
	color:			#fff;
	margin:			2px 4px;
}
#form button + button {
	margin:			inherit;
}
select {
	padding:		0px 1px;
}
#iframe {
	width:			100%;
	min-height:		0;
	overflow-x:		hidden;
	overflow-y:		scrollbar;
	border:			none;
	background-color:	#fff;

	position:		absolute;
	left:			0px;

}
</style>
</head>
<body id="body">
<!--========================================================================-->
<form id="form" action="<@v.myself>?<@v.skeleton>" method="POST">
<input type="hidden" name="action" value="<@v.skeleton>">
<input type="hidden" name="csrf_check_key" value="<@CSRF_check_key>">
テーマ選択
<select id="theme-select" name="theme">
<@forexec(tp, v.load_templates(), begin)>
<@forexec(t,  v.load_themes(tp), begin)>
	<option value="<@tp><@t.name>" data-readme="<@t.readme>"><@tp><@t.name></option>
<$end>
<$end>
</select>
<button type="submit">保存</button>
<button type="button" onclick="window.location='<@v.myself>?<@v.skel_dir>'">戻る</button>
&nbsp;
<button type="button" id="readme-button" class="info" data-title="README" data-url="" data-class="pre" onclick>README表示</button>
<input type="hidden" name="checkbox.info" value="sysmode_notheme_flg">
<input type="checkbox" name="sysmode_notheme_flg" value="1"<@if(s.sysmode_notheme, ' checked')>><label class="small">管理画面は標準テーマを使用</label>
</form>
<iframe id="iframe" ></iframe>

<!--========================================================================-->
<script>
$(function(){
	var body = $('#body');
	var form = $('#form');
	var iframe = $('#iframe');
	var readme = $('#readme-button');
	
	// bodyいっぱいに表示
	iframe_resize();
	$(window).resize( iframe_resize );

	// テーマ変更
	var sel = $('#theme-select');
	sel.val('<@v.template>/<@v.theme>');	// default
	var theme_query='';

	// テーマ選択操作
	sel.change(function(){
		var theme = sel.val();
		theme_query = '?theme&n=' + theme;
		iframe.attr('src', '<@v.myself>' + theme_query ); 
		var opt = sel.children(':selected');
		if (opt.data('readme')) {
			readme.data('url', '<@v.myself>' + '?<@v.skel_dir>theme_readme&name=' + theme);
			readme.removeAttr('disabled');
		} else {
			readme.attr('disabled', true);
		}
	});
	sel.change();

	// iframe内のリンク書き換え
	iframe.on('load', function(){
		if (!theme_query) return;
	iframe.contents().find('a').each(function(idx,dom) {
		var obj = $(dom);
		var url = obj.attr('href');
		if (!url) return;
		if (url.substr(0,<@length(v.myself)>) != '<@v.myself>') {
			obj.attr('target', '_top');
			return;
		}
		var m;
		if (m = url.match(/(.*?)\?(&.*)/)) {
			url = m[1] + theme_query + m[2];
		} else if (0 < url.indexOf('?')) {
			return;
		} else if (m = url.match(/(.*?)(#.*)/)) {
			url = m[1] + theme_query + m[2];
		} else {
			url += theme_query;
		}
		obj.attr('href', url);

	});	// contents
	});	// onload

function iframe_resize() {
	var h = body.height() - iframe.position().top;
	$('#debug-msg').html(body.height() + ' / ' + iframe.position().top);
	iframe.css('height', h);
}
///
});
</script>

<@ifexec(Develop && (@Error || @Debug || @Warning), begin.debug)>
<!--追加フッタ==============================================================-->
<p><strong>debug</strong></p>

<@ifexec(@Error, begin)>
<div class="debug">
Error : <strong><@error_load_and_clear("<br>\n")></strong><br>
</div>
<$end>
<@ifexec(@Debug, begin)>
<div class="debug">
Debug : <strong><@join("<br>\n", Debug)></strong><br>
</div>
<$end>
<@ifexec(@Warning, begin)>
<div class="debug">
Warning : <strong><@join("<br>\n", Warning)></strong><br>
</div>
<$end>
<$end.debug>

</body>
</html>
