<@6>
<@local(s,art,logs,t,edit_pkey)>
<$s = v.blog>

<@> システムモード
<$v.system_mode()>
<$v.title ="記事を書く - " . s.blog_name>

<@>CSRFチェック
<$if_post_csrf_check()>

<@> ログインしていない
<$ifjump(!Auth.ok && ENV.REQUEST_METHOD ne 'POST', 'login')>

<@> ブログが存在しない or 権限がない
<$ifexec(! v.allow_edit, begin)>
<$redirect( v.myself . '?blog_create' )>
<$end>

<@> 編集モードなら記事をロード
<$ifexec(v.pinfo, begin, begin)>
	<$art = v.load_article_current_blog(v.pinfo, undef, flagq(no_override))>
	<$ifexec(! defined art, begin)>
		<$ifjump_clear(! POST, '_sub/error_message', '指定の記事がみつかりません')>
	<$end>
	<$ifset(!Query.template, edit_pkey, art.pkey)>
	<$ifexec(art.draft, begin, begin)>
		<@> 下書き
		<$art.enable  = s.enable>
		<$art.ping    = s.ping>
		<$art.tw_ping = s.tw_ping>
	<$else>
		<$art_year = art.year>
		<$art_mon  = art.mon>
		<$art_day  = art.day>
	<$end>
<$else>
	<$art.name    = Auth.name>
	<$art.enable  = s.enable>
	<$art.com_ok  = s.com_ok>
	<$art.hcom_ok = s.hcom_ok>
	<$art.ping    = s.ping>
	<$art.tw_ping = s.tw_ping>
	<$art.wiki    = s.wiki>
	<$art.parser  = s.parser>
<$end>

<@> エラーなら表示して終了
<$ifjump_clear(@Message, '_sub/error_message', undef, 'ブラウザの戻るボタンで戻ってください')>

<@> 他人のブログ？
<#@call('_sub/others_blog_check')>

<@> 他人の記事は編集できない？
<$ifjump_clear(edit_pkey && !v.check_editor(art), '_sub/error_message', '他人の記事は編集できません。')>

<@> スクリプトをロード
<$v.regist_js('edit.js')>

<@><!--下書きのロード=======================================================-->
<$logs2 = v.load_arts_list( { draft_only => 1} )>
<$logs = []>
<$forexec(t, logs2, begin)>
	<$ifpush(v.check_editor(t), logs, t)>
<$end>
<@ifexec(@logs, begin)>
<article class="system notice" id="draft-notice">
<h2>下書きを開く</h2>
<div class="body">
	<select name="open_draft" id="select-draft" data-base-url="<@v.myself2>">
	<@forexec(t, logs, begin)>
		<option value="<@t.pkey>"<@if(edit_pkey == t.pkey,' selected')>><@v.format_ymd(t.yyyymmdd)> <@t.title> by <@t.name></option>
	<$end>
	</select>
	<button type="button" id="open-draft">開く</button>
	<button type="button" id="open-template">テンプレートとして開く</button>
</div>
</article>
<$end>


<!--記事の編集=============================================================-->
<article class="system edit">
<h2>記事の編集</h2>
<div class="body">

<form method="POST" name="edit" class="no-enter-submit">
	<input type="hidden" name="action" value="<@v.skeleton>">
	<input type="hidden" name="csrf_check_key" value="<@CSRF_check_key>">
<@ifexec(edit_pkey, begin)>
	<input type="hidden" name="edit_pkey_int" value="<@edit_pkey>">
<$end>
	<span class="element" id="edit-yyyymmdd">
	<span class="edit-caption">日付</span> <input type="date" name="ymd" class="w120" value="<@if(art_year, "<@art_year>-<@art_mon>-<@art_day>", "<@v.now.year>-<@v.now.mon>-<@v.now.day>")>" min="1980-01-01" max="9999-12-31" required></span>

	<span class="element" id="edit-tags"><span class="edit-caption">タグ</span> 
	<span id="tags"><$tags = split(',', art.tags)>
	<@forexec(t, tags, begin)><span class="tag"><@t><input type="hidden" name="tag_ary" value="<@t>"></span><$end>
	</span></span>
	
	<select name="taglist" id="tag-select" data-url="<@Basepath><@v.blogpub_dir>taglist.json">
		<option value="" class="special">【追加するタグを選択】</option>
		<option value="*" class="special" data-new="1">【新規に登録】</option>
	</select><br>
	<div style="display:none">
	<span id="new-tag-title">タグを入力</span>
	<span id="new-tag-msg">※階層の区切りは「<span class="mono">::</span>」です</span>
	<span id="new-tag-append">追加</span>
	<span id="new-tag-cancel">キャンセル</span>
	</div>
	<br>

	<span class="element" id="edit-title"><span class="edit-caption">タイトル</span> <input class="w360 no-enter-submit" type="text" name="title" size="44" value="<@art.title>"></span> 
	<span class="element edit-writer"><span class="edit-caption">投稿者</span> <@art.name></span>

	<textarea name="body_txt" id="editarea" cols="60" rows="16" class="edit-article"><@tag_escape_amp(art._text)></textarea>

	<span class="element" id="select-parser"><span class="edit-caption">パーサ</span>
	<select name="parser">
		<@forexec_hash(ROBJ, v.parsers, begin)><option value="<@key>"<@if(art.parser eq key, ' selected')>><@val></option>
		<$end>
	</select></span>
	<@if(!edit_pkey || art.draft, '<input type="submit" name="draft" id="save-draft" value="下書き保存"><span class="help" data-help="下書きは記事一覧にも表示されません">?</span>')>
	<input type="submit" name="edit" id="save-normal" value="<@if(edit_pkey, '編集内容を保存', 'この記事を新規に登録')>">
	<br>
	<a href="http://adiary.blog.abk.nu/0290" target=_blank>記法の暫定ヘルプはこちら</a>
	<@ifexec(Develop || Debug_mode, begin)>
		<input type="checkbox" class="js-switch" data-target="#-dummy-" data-save="1" id="parser-debug" name="parser_debug" value="1"><label for="parser-debug">パーサーのデバッグ</label>
	<$end>

	<!--===============================================================-->
	<input type="hidden" name="checkbox.info" value="enable">
	<input type="hidden" name="checkbox.info" value="draft">
	<input type="hidden" name="checkbox.info" value="allow_com">
	<input type="hidden" name="checkbox.info" value="allow_hcom">
	<input type="hidden" name="checkbox.info" value="ping">
	<input type="hidden" name="checkbox.info" value="auto_tb">
	<input type="hidden" name="checkbox.info" value="tw_ping">
	<input type="hidden" name="checkbox.info" value="wiki">
	<ul class="checkbox">
		<li><input type="checkbox" name="enable" value="1"<@if(art.enable, ' checked')>><label>記事を公開</label><span class="help" data-help="公開設定に関わらず、下書きは公開されません">?</span></li>
		<li><input type="checkbox" name="com_ok" value="1"<@if(art.com_ok, ' checked')>><label>コメントを受け付ける</label></li>
		<li><input type="checkbox" name="hcom_ok" value="1"<@if(art.hcom_ok, ' checked')>><label>非公開コメントを許可する</label></li>
	<@ifexec(!s.private && (art.draft || !edit_pkey), begin)>
		<@ifexec(v.sys.ping_servers_txt, begin)>
		<li><input type="checkbox" name="ping" value="1"<@if(s.ping, ' checked')>><label>更新通知Pingを送信する</label><span class="help" data-help="更新通知を送ると他の人があなたの記事を見つけやすくなります。\n【送信先】\n<@v.sys.ping_servers_txt>">?</span></li>
		<$end>
		<@ifexec(s.tw_access_token, begin)>
		<li><input type="checkbox" name="tw_ping" value="1"<@if(art.tw_ping, ' checked')>><label>Twitterに通知する</label></li>
		<$end>
	<$end>
		<li><input type="checkbox" name="wiki" value="1" data-target="#wiki-block" class="js-switch"<@if(art.ctype || art.wiki, ' checked')>><label>wikiコンテンツにする</label>
		<input type="hidden" name="priority" value="<@art.priority>">
		<ul id="wiki-block" style="display: none">
			<li>親ノード：<select name="upnode" id="upnode-select" data-default="<@art.upnode>" data-this-pkey="<@edit_pkey>" data-url="<@Basepath><@v.blogpub_dir>contents.json">
				<option value="0">*トップ(root)</option>
			</select></li>
			<li>コンテンツkey：<input type="text" name="link_key" class="w240" value="<@if(art.ctype, esc(art.link_key))>"></li>
		</ul>
		</li>
		<@ifexec(!art.draft && edit_pkey, begin)>
		<li><input type="checkbox" name="draft" value="1"<@if(art.draft, ' checked')>><label>この記事を下書きとして保存する</label><span class="help" data-help="初公開日時の情報も消去されます。">?</span></li>
		<$end>
	</ul>

	<input type=submit name="edit" id="save-last" value="<@if(edit_pkey, '編集内容を保存', 'この記事を新規に登録')>">
</form>
<@ifexec(edit_pkey, begin)>
	<ul class="checkbox">
	<li><input type="checkbox" name="post_detail" data-target="#post-detail" class="js-switch"<@if(s.post_detail, ' checked')>> <@\>
	<label>投稿の詳細情報表示</label>
		<ul id="post-detail"<@if(!s.post_detail, ' style="display: none"')>>
			<@ifexec(art.tm,begin)>
			<li>書き込み日時 <span title="<@art.tm>"><@tm_printf("%Y/%m/%d %J:%M:%S", art.tm)></span></li>
			<$end>
			<li>最終更新日時 <@tm_printf("%Y/%m/%d %J:%M:%S", art.update_tm)></li>
			<li>IP <@art.ip></li>
			<li>HOST <@art.host></li>
			<li>AGENT <@art.agent></li>
		</ul></li>
	<li><input type="checkbox" name="del_check" value="1" id="del-check"><label>削除確認</label></li>
	</ul>
<form method="POST" action="<@v.myself2>" class="delete js-form-check" data-flag="#del-check" data-confirm="この記事を本当に削除しますか？">
	<input type="hidden" name="action" value="delete">
	<input type="hidden" name="csrf_check_key" value="<@CSRF_check_key>">
	<input type="hidden" name="delete_pkey_int_ary" value="<@edit_pkey>">
	<input type="hidden" name="title" value="<@art.title>">
	<input type="submit" name="delete" value="この記事を削除する">
</form>
<$end>
</div> <!-- end of body -->
</article>
