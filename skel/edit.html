<@6>
<@local(s,art,logs,t,edit_pkey)>
<$s = v.blog>

<@> システムモード
<$v.system_mode("記事の編集")>

<@>CSRFチェック
<$if_post_csrf_check()>

<@> ログインしていない
<$ifjump(!Auth.ok && ENV.REQUEST_METHOD ne 'POST', 'login')>

<@> ブログが存在しない or 権限がない
<$ifexec(! v.allow_edit, begin)>
<$redirect( v.myself . '?blog_create' )>
<$end>

<@> 編集モードなら記事をロード
<$ifexec(v.pinfo, begin, begin)>
	<$art = v.load_article_current_blog(v.pinfo, undef, flagq(no_override))>
	<$ifexec(! defined art, begin)>
		<$ifjump_clear(! POST, '_sub/error_message', '指定の記事がみつかりません')>
	<$end>
	<$ifset(!Query.template, edit_pkey, art.pkey)>
	<$ifexec(art.draft, begin, begin)>
		<@> 下書き
		<$art.enable  = s.enable>
		<$art.ping    = s.ping>
		<$art.tw_ping = s.tw_ping>
	<$else>
		<$art_year = art.year>
		<$art_mon  = art.mon>
		<$art_day  = art.day>
	<$end>
<$else>
	<$art.name    = Auth.name>
	<$art.enable  = s.enable>
	<$art.com_ok  = s.com_ok>
	<$art.hcom_ok = s.hcom_ok>
	<$art.ping    = s.ping>
	<$art.tw_ping = s.tw_ping>
	<$art.wiki    = s.wiki>
	<$art.parser  = s.parser>
<$end>

<@> 画面タイトル
<$ifset(!edit_pkey, v.title, '記事の作成')>
<@> 保存ボタンの名前
<$save_btn_text = '<span class="save-btn-title">編集して</span>' . if(edit_pkey, '保存', '作成')>

<@> エラーなら表示して終了
<$ifjump_clear(@Message, '_sub/error_message', undef, 'ブラウザの戻るボタンで戻ってください')>

<@> 他人のブログ？
<#@call('_sub/others_blog_check')>

<@> 他人の記事は編集できない？
<$ifjump_clear(edit_pkey && !v.check_editor(art), '_sub/error_message', '他人の記事は編集できません。')>

<@> スクリプトをロード
<$v.regist_js("<@v.script_dir>edit.js")>

<@ifexec(!edit_pkey && !form_.paste_txt, begin)>
<@><!--下書きのロード=======================================================-->
<$logs2 = v.load_arts_list( { draft_only => 1} )>
<$logs = []>
<$forexec(t, logs2, begin)>
	<$ifpush(edit_pkey != t.pkey && v.check_editor(t), logs, t)>
<$end>
<@ifexec(@logs, begin)>
<article class="system notice" id="draft-notice">
<h2>下書きを開く</h2>
<div class="body">
	<select name="open_draft" id="select-draft" data-base-url="<@v.myself2>">
	<@forexec(t, logs, begin)>
		<option value="<@t.pkey>"<@if(edit_pkey == t.pkey,' selected')>><@v.format_ymd(t.yyyymmdd)> <@t.title><@if(t.id ne Auth.id, " by <@t.name>")></option>
	<$end>
	</select>
	<div id="open-draft-buttons">
	<button type="button" id="open-draft">開く</button>
	<button type="button" id="open-template" class="btn-help" data-help="テンプレートとして開くと、編集・保存しても元にした下書きは残り続けます。">テンプレートに</button>
	</div>
</div>
</article>
<$end>
<$end>

<@><!--下書きのロード=======================================================-->
<article class="system notice" id="edit-lock-notice" style="display: none;">
<h2>他にもこの記事を編集している人がいます</h2>
<div class="body">
	<ul id="edit-lockers"></ul>
<button id="force-lock-check">確認</button> <span id="check-time"></span>
</div>
</article>

<!--記事の編集=============================================================-->
<article class="system edit" id="edit">
<h2 ><@v.title></h2>
<div class="body">

<form method="POST" name="edit" class="no-enter-submit">

	<input type="hidden" name="action" value="<@v.skeleton>">
	<input type="hidden" name="csrf_check_key" value="<@CSRF_check_key>" id="csrf-key">
<@ifexec(edit_pkey, begin)>
	<input type="hidden" name="edit_pkey_int" value="<@edit_pkey>" id="edit-pkey">
<$end>
	<@ifexec(edit_pkey, begin)>
	<div class="float-r">
		<a href="<@v.myself2><@art.elink_key>">記事を開く</a>
	</div>
	<$end>
	<div>
	<span class="element" id="edit-yyyymmdd">
	<span class="edit-caption">日付</span><input id="edit-date" type="date" name="ymd" class="w120" value="<@if(art_year, "<@art_year>-<@art_mon>-<@art_day>", "<@v.now.year>-<@v.now.mon>-<@v.now.day>")>" min="1980-01-01" max="2999-12-31" required>
	</span>

	<span class="element" id="edit-tags"><span class="edit-caption">タグ</span>
	<span id="tags"><$tags = split(',', art.tags)>
	<@forexec(t, tags, begin)>
		<span class="tag"><@t><input type="hidden" name="tag_ary" value="<@t>"></span>
	<$end></span>
	<button type="button" id="edit-add-tag" data-title="タグを選択か入力">追加</button>
	</span>
	</div>
	<br>

	<div>
	<span class="element" id="edit-title"><span class="edit-caption">タイトル</span><input class="w360 no-enter-submit" type="text" name="title" value="<@art.title>"></span> 
	<div id="edit-helper">
	<button class="helper" type="button" id="btn-strong" data-msg="太字にしたい文字列を入力">太字</button>
	<button class="helper" type="button" id="btn-link"   data-msg="リンクを生成" data-msg1="リンク先" data-val1="http://" data-msg2="リンク文字列">リンク</button>
	<button class="helper" type="button" id="btn-google" data-msg="Google検索へのリンクを生成" data-msg1="検索する言葉" data-msg2="リンク文字列">検索</button>
	<button class="helper" type="button" id="btn-list"   data-msg="箇条書きにしたい項目を１行ずつ入力">箇条<@if(!v.sphone,'書き')></button>
	<button class="helper" type="button" id="btn-quote"  data-msg="引用したい文章を入力" data-sp-msg="引用元サイトがある場合、そのURLを入力してください">引用</button>
	<button class="helper" type="button" id="btn-annotation" data-msg="注釈にしたい文字列を入力">注釈</button>
	<button class="helper btn-help" type="button" id="album-open" data-url="<@v.myself>?album/#edit" data-help="画像アルバムからファイルを選択して貼り付けます。">画像</button>
	<select class="helper" id="select-color" title="選択した文字列に色を付けます。" data-msg="色を変更したい文字列を入力">
		<option value="" selected>色</option>
		<option value="#FF0000" style="color:#FF0000;">■</option>
		<option value="#FFFF00" style="color:#FFFF00;">■</option>
		<option value="#00FF00" style="color:#00FF00;">■</option>
		<option value="#00FFFF" style="color:#00FFFF;">■</option>
		<option value="#0000FF" style="color:#0000FF;">■</option>
		<option value="#FF00FF" style="color:#FF00FF;">■</option>
		<option value="#800000" style="color:#800000;">■</option>
		<option value="#808000" style="color:#808000;">■</option>
		<option value="#008000" style="color:#008000;">■</option>
		<option value="#008080" style="color:#008080;">■</option>
		<option value="#000080" style="color:#000080;">■</option>
		<option value="#800080" style="color:#800080;">■</option>
		<option value="#000000" style="color:#000000;">■</option>
		<option value="#808080" style="color:#808080;">■</option>
		<option value="#C0C0C0" style="color:#C0C0C0;">■</option>
		<option value="#FFFFFF" style="color:#000000;">□</option>
	</select>
	<select class="helper" id="select-fontsize" title="選択した文字列のサイズを変えます。"  data-start-base="[" data-end="]" data-msg="サイズを変更したい文字列を入力">
		<option value="" selected>サイズ</option>
		<option value="xx-large">大大大</option>
		<option value="x-large">大大</option>
		<option value="large">大</option>
		<option value="small">小</option>
		<option value="x-small">小小</option>
		<option value="xx-small">小小小</option>
	</select>
	<a href="http://adiary.org/v3man/Satsuki/" data-default="Satsuki/" data-markdown="Markdown/" target=_blank id="parser-help-link">記法ヘルプ</a>
	<@ifexec(!v.trust_mode, begin)>
	<a href="<@v.myself>?etc/allow_tags&amp;n=article" target="_blank">HTMLタグ</a>
	<$end>
	</div>

	<textarea name="body_txt" id="editarea" cols="60" rows="16" class="edit-article"><@tag_escape_amp( txt = art._text || form_.paste_txt)></textarea>

	<span class="element" id="select-parser-span">
<@>		<span class="edit-caption">入力記法</span>
		<select name="parser" id="select-parser">
		<@forexec_hash(ROBJ, v.parsers, begin)><option value="<@key>"<@if(art.parser eq key, ' selected')>><@val></option>
		<$end>
	</select></span>

	<button type="button" id="edit-file-upload" class="btn-help js-fileup" data-folder="<@if(s.edit_upload ne '', s.edit_upload, 'adiary/%y/')>" data-title="ファイルを選択" data-help="ファイルを直接アップロードして記事に貼付けます。記事エリアに直接ドラッグ＆ドロップすることもできます。IE9非対応。">Upload</button>
	<button type="submit" name="edit" id="save-normal" value="1"><@save_btn_text></button>
	<@ifexec(!edit_pkey || art.draft, begin)>
	<button type="submit" name="draft" value="1" id="save-draft" class="btn-help" data-help="下書きは記事一覧にも表示されません。下書き記事は、テンプレートとして使用することもできます。">下書き<@if(edit_pkey, '保存', '作成')></button>
	<$end>

	<!--===============================================================-->
	<input type="hidden" name="checkbox.info" value="enable">
	<input type="hidden" name="checkbox.info" value="draft">
	<input type="hidden" name="checkbox.info" value="allow_com">
	<input type="hidden" name="checkbox.info" value="allow_hcom">
	<input type="hidden" name="checkbox.info" value="ping">
	<input type="hidden" name="checkbox.info" value="auto_tb">
	<input type="hidden" name="checkbox.info" value="tw_ping">
	<input type="hidden" name="checkbox.info" value="wiki">
	<ul class="checkbox">
		<li>
		<@ifexec(!art.enable || art.draft || !edit_pkey, begin, begin)>
		<input type="checkbox" name="enable" value="1" id="enable-chk" data-on="公開して" data-off="非公開で"<@if(art.enable, ' checked')>> <@\>
		<$else>
		<input type="checkbox" name="enable" value="1" id="enable-chk" data-on="編集して" data-off="非公開で"<@if(art.enable, ' checked')>> <@\>
		<$end> <@\>
		<label>記事を公開</label><span class="help" data-help="公開設定に関わらず、下書きは公開されません">?</span></li>
		<li><input type="checkbox" id="art-detail-sw" data-target="#art-detail" class="js-switch js-save"> <@\>
		<label>詳細設定</label>
		<ul id="art-detail" class="checkbox">
			<li><input type="checkbox" name="com_ok" value="1"<@if(art.com_ok, ' checked')>><label>コメントを受け付ける</label></li>
			<li><input type="checkbox" name="hcom_ok" value="1"<@if(art.hcom_ok, ' checked')>><label>非公開コメントを許可する</label></li>
		<@ifexec(!s.private && (art.draft || !edit_pkey), begin)>
			<@ifexec(v.sys.ping_servers_txt, begin)>
			<li><input type="checkbox" name="ping" value="1"<@if(s.ping, ' checked')>><label>更新通知Pingを送信する</label><span class="help" data-help="更新通知を送ると他の人があなたの記事を見つけやすくなります。プラグインのTwitter通知もこの設定を参照します。\n【送信先】\n<@v.sys.ping_servers_txt>">?</span></li>
			<$end>
		<$end>
		<@ifexec(!art.draft && edit_pkey, begin)>
			<li><input type="checkbox" name="draft" value="1"<@if(art.draft, ' checked')> id="draft-chk" data-on='下書き'><label>この記事を下書きとして保存する</label><span class="help" data-help="初公開日時の情報も消去されます。">?</span></li>
		<$end>
		<@ifexec(Develop && !v.sphone, begin)>
			<li><input type="checkbox" class="js-save" data-save="1" id="parser-debug" name="parser_debug" value="1"><label for="parser-debug"><em>[develop]</em> パーサーのデバッグ</label></li>
		<$end>
		</ul></li>
		<li><input type="checkbox" name="wiki" value="1" data-target="#content-block" class="js-switch"<@if(art.ctype || art.wiki, ' checked')>><label>コンテンツページにする</label>
		<input type="hidden" name="priority" value="<@art.priority>">
		<ul id="content-block" style="display: none">
			<li>親 <select name="upnode" id="upnode-select" data-default="<@art.upnode>" data-this-pkey="<@edit_pkey>" data-url="<@Basepath><@add_lastmodified(v.blogpub_dir . 'contents.json')>">
				<option value="0">*トップ(root)</option>
			</select></li>
			<li>コンテンツkey<span class="help" data-help='"http://" や "/" ではじまるkeyを指定するとリンクになります。"FrontPage", "top", "index"のいずれかを指定するとブログトップの固定記事になります。'>?</span><input type="text" name="link_key_txt" id="link-key" class="w240" value="<@if(art.ctype, esc(art.link_key))>" data-suggest="<@s.suggest_link_key>"></li>
		</ul>
		</li>
	</ul>

	<button type="submit" name="edit" id="save-last" value="1"><@save_btn_text></button>
</form>
<@ifexec(edit_pkey, begin)>
	<ul class="checkbox">
	<li><input type="checkbox" data-target="#post-detail" class="js-switch"> <@\>
	<label>投稿情報の表示</label>
		<ul id="post-detail"<@if(!s.post_detail, ' style="display: none"')>>
			<li>記事番号 <@edit_pkey></li>
			<li>投稿者 <@art.name> (id=<@art.id>)</li>
			<@ifexec(art.tm,begin)>
			<li>投稿日時 <span title="<@art.tm>"><@tm_printf("%Y/%m/%d %J:%M:%S", art.tm)></span></li>
			<$end>
			<li>更新日時 <@tm_printf("%Y/%m/%d %J:%M:%S", art.update_tm)></li>
			<li>IP <@art.ip></li>
			<li>HOST <@art.host></li>
			<li>AGENT <@art.agent></li>
		</ul></li>
 	<li><input type="checkbox" id="del-submit-check" class="js-enable" data-target="#del-submit"><label>削除確認</label></li>
	</ul>
<form method="POST" action="<@v.myself2>" class="delete js-form-check" data-confirm="本当にこの記事を削除しますか？" data-focus="cancel">
	<input type="hidden" name="action" value="delete">
	<input type="hidden" name="csrf_check_key" value="<@CSRF_check_key>">
	<input type="hidden" name="delete_pkey_int_ary" value="<@edit_pkey>">
	<input type="hidden" name="title" value="<@art.title>">
	<button type="submit" name="delete" id="del-submit" class="no-disable">この記事を削除する</button>
</form>
<$end>
</div> <!-- end of body -->
</article>


<input type="hidden" value="<@v.sys.edit_lock_time>" id="edit-lock-time">
<div style="display:none">
<span id="new-tag-append">追加</span>
<span id="new-tag-cancel">キャンセル</span>
<span id="edit-confirm">この記事を編集している人が他にいますが、編集を継続しますか？%u</span>
<span id="msg-multiline">複数行を一度に処理できません。</span>
<span id="msg-for-ie8">このブラウザではこの機能は使用できません。</span>
<span id="msg-upload-error">アップロードに失敗しました。</span>
<span id="msg-upload-fail">%n 個中 %f 個のアップロードに失敗しました。</span>
<span id="image-dir"><@v.blogimg_dir()></span>


<@> タグ追加フォーム
<div id="tag-select-form">
<div><select name="taglist" id="tag-select" data-url="<@Basepath><@add_lastmodified(v.blogpub_dir . 'taglist.json')>">
	<option value="" class="special" data-new="1">【タグを選択か入力】</option>
</select></div>
<div style="margin-top: 1em;">
入力 <input id="input-new-tag" type="text" class="w200 mono"><br>
※階層の区切りは「<span class="mono">::</span>」です。<br>※「,」は使用できません。</span>
</div>
</div>


<@> ファイルアップロード用データ
<$tags = call('album/_load_tags')>
<span id="paste-tag" data-file="<@tags.file>"></span>

<div id="thumbnail-info"><br>
<select name="paste">
	<option value="<@tags.thumb>">サムネイルを貼付</option>
	<option value="<@tags.image>">大きい画像を貼付</option>
</select>&ensp;

サムネイル<select name="size" id="thumbnail-size" class="r js-save js-combo" data-target="#size-other" data-format="%vpx">
	<option value="120" selected>120px</option>
	<option value="160">160px</option>
	<option value="240">240px</option>
	<option value="320">320px</option>
	<option value="400">400px</option>
	<option value="480">480px</option>
</select></div>
<div id="size-other" data-title="サムネイルサイズ">
<input type="number" value="120" class="w50" min="60" max="800">px （60～800）
</div>


</div>

