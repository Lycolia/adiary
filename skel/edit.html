<@6>
<@local(s,art,logs,t,edit_pkey)>
<$s = v.blog>

<@> システムモード
<$v.system_mode()>
<$v.title ="記事を書く - " . s.blog_name>

<@>CSRFチェック
<$if_post_csrf_check()>

<@> ログインしていない
<$ifjump(!Auth.ok && ENV.REQUEST_METHOD ne 'POST', 'login')>

<@> ブログが存在しない or 権限がない
<$ifexec(! v.allow_edit, begin)>
<$redirect( v.myself . '?blog_create' )>
<$end>

<@> 編集モードなら記事をロード
<$ifexec(v.pinfo, begin, begin)>
	<$art = v.load_article_current_blog(v.pinfo, undef, flagq(no_override))>
	<$ifexec(! defined art, begin)>
		<$ifjump_clear(! POST, '_sub/error_message', '指定の記事がみつかりません')>
	<$end>
	<$ifset(!Query.template, edit_pkey, art.pkey)>
	<$ifexec(art.draft, begin, begin)>
		<@> 下書き
		<$art.enable  = s.enable>
		<$art.ping    = s.ping>
		<$art.tw_ping = s.tw_ping>
	<$else>
		<$art_year = art.year>
		<$art_mon  = art.mon>
		<$art_day  = art.day>
	<$end>
<$else>
	<$art.name    = Auth.name>
	<$art.enable  = s.enable>
	<$art.com_ok  = s.com_ok>
	<$art.hcom_ok = s.hcom_ok>
	<$art.ping    = s.ping>
	<$art.tw_ping = s.tw_ping>
	<$art.wiki    = s.wiki>
	<$art.parser  = s.parser>
<$end>

<@> エラーなら表示して終了
<$ifjump_clear(@Message, '_sub/error_message', undef, 'ブラウザの戻るボタンで戻ってください')>

<@> 他人のブログ？
<#@call('_sub/others_blog_check')>

<@> 他人の記事は編集できない？
<$ifjump_clear(edit_pkey && !v.check_editor(art), '_sub/error_message', '他人の記事は編集できません。')>

<@> スクリプトをロード
<$v.regist_js("<@v.script_dir>edit.js")>

<@><!--下書きのロード=======================================================-->
<$logs2 = v.load_arts_list( { draft_only => 1} )>
<$logs = []>
<$forexec(t, logs2, begin)>
	<$ifpush(v.check_editor(t), logs, t)>
<$end>
<@ifexec(@logs, begin)>
<article class="system notice" id="draft-notice">
<h2>下書きを開く</h2>
<div class="body">
	<select name="open_draft" id="select-draft" data-base-url="<@v.myself2>">
	<@forexec(t, logs, begin)>
		<option value="<@t.pkey>"<@if(edit_pkey == t.pkey,' selected')>><@v.format_ymd(t.yyyymmdd)> <@t.title> by <@t.name></option>
	<$end>
	</select>
	<button type="button" id="open-draft">開く</button>
	<button type="button" id="open-template">テンプレートとして開く</button><span class="help" data-help="テンプレートとして開くと、編集・保存しても元にした下書きは残り続けます。">?</span>
</div>
</article>
<$end>

<@><!--下書きのロード=======================================================-->
<article class="system notice" id="edit-lock-notice" style="display: none;">
<h2>他にもこの記事を編集している人がいます</h2>
<div class="body">
	<ul id="edit-lockers"></ul>
<button id="force-lock-check">確認</button> <span id="check-time"></span>
</div>
</article>

<!--記事の編集=============================================================-->
<article class="system edit" id="edit">
<h2>記事の編集</h2>
<div class="body">

<form method="POST" name="edit" class="no-enter-submit">

	<input type="hidden" name="action" value="<@v.skeleton>">
	<input type="hidden" name="csrf_check_key" value="<@CSRF_check_key>" id="csrf-key">
<@ifexec(edit_pkey, begin)>
	<input type="hidden" name="edit_pkey_int" value="<@edit_pkey>" id="edit-pkey">
	<div class="float-r" id="edit-disp-pkey"><@edit_pkey></div>
<$end>
	<span class="element" id="edit-yyyymmdd">
	<span class="edit-caption">日付</span> <input type="date" name="ymd" class="w120" value="<@if(art_year, "<@art_year>-<@art_mon>-<@art_day>", "<@v.now.year>-<@v.now.mon>-<@v.now.day>")>" min="1980-01-01" max="2999-12-31" required></span>

	<span class="element" id="edit-tags"><span class="edit-caption">タグ</span> 
	<span id="tags"><$tags = split(',', art.tags)>
	<@forexec(t, tags, begin)><span class="tag"><@t><input type="hidden" name="tag_ary" value="<@t>"></span><$end>
	</span></span>
	
	<select name="taglist" id="tag-select" data-url="<@Basepath><@v.blogpub_dir>taglist.json">
		<option value="" class="special">【追加するタグを選択】</option>
		<option value="*" class="special" data-new="1">【新規に登録】</option>
	</select><br>
	<br>

	<span class="element" id="edit-title"><span class="edit-caption">タイトル</span> <input class="w360 no-enter-submit" type="text" name="title" value="<@art.title>"></span> 
	<span class="element edit-writer"><span class="edit-caption">投稿者</span> <@art.name></span>
	<div id="edit-helper">
	<button class="helper" type="button" id="btn-strong" data-msg="太字にしたい文字列を入力" data-start="[bf:" data-end="]">太字</button>
	<button class="helper" type="button" id="btn-link"   data-msg="リンクを生成" data-msg1="リンク先" data-val1="http://" data-msg2="リンク文字列">リンク</button>
	<button class="helper" type="button" id="btn-google" data-msg="Google検索へのリンクを生成" data-msg1="検索する言葉" data-msg2="リンク文字列" data-start="[g:" data-end="]">検索</button>
	<button class="helper" type="button" id="btn-list"   data-msg="箇条書きにしたい項目を１行ずつ入力" data-tag="-" data-type="lines">箇条書き</button>
	<button class="helper" type="button" id="btn-quote"  data-msg="引用したい文章を入力" data-start-base=">>" data-end="<<" data-type="block" data-sp-msg="引用元サイトがある場合、そのURLを入力してください">引用</button>
	<button class="helper" type="button" id="btn-annotation" data-msg="注釈にしたい文字列を入力" data-start="((" data-end="))">注釈</button>
	<button class="helper" type="button" id="album-open" data-url="<@v.myself>?album/#edit">画像</button>
	<select class="helper" id="select-color" title="選択した文字列に色を付けます。" data-start-base="[color:" data-end="]" data-msg="色を変更したい文字列を入力">
		<option value="" selected>色</option>
		<option value="#FF0000" style="color:#FF0000;">■</option>
		<option value="#FFFF00" style="color:#FFFF00;">■</option>
		<option value="#00FF00" style="color:#00FF00;">■</option>
		<option value="#00FFFF" style="color:#00FFFF;">■</option>
		<option value="#0000FF" style="color:#0000FF;">■</option>
		<option value="#FF00FF" style="color:#FF00FF;">■</option>
		<option value="#800000" style="color:#800000;">■</option>
		<option value="#808000" style="color:#808000;">■</option>
		<option value="#008000" style="color:#008000;">■</option>
		<option value="#008080" style="color:#008080;">■</option>
		<option value="#000080" style="color:#000080;">■</option>
		<option value="#800080" style="color:#800080;">■</option>
		<option value="#000000" style="color:#000000;">■</option>
		<option value="#808080" style="color:#808080;">■</option>
		<option value="#C0C0C0" style="color:#C0C0C0;">■</option>
		<option value="#FFFFFF" style="color:#000000;">□</option>
	</select>
	<select class="helper" id="select-fontsize" title="選択した文字列のサイズを変えます。"  data-start-base="[" data-end="]" data-msg="サイズを変更したい文字列を入力">
		<option value="" selected>サイズ</option>
		<option value="xx-large">大大大</option>
		<option value="x-large">大大</option>
		<option value="large">大</option>
		<option value="small">小</option>
		<option value="x-small">小小</option>
		<option value="xx-small">小小小</option>
	</select>
	<a href="http://adiary.org/v3man/Satsuki/" data-default="Satsuki/" data-markdown="Markdown" target=_blank id="parser-help-link">記法のヘルプ</a>
	</div>

	<textarea name="body_txt" id="editarea" cols="60" rows="16" class="edit-article"><@tag_escape_amp( txt = art._text || form_.paste_txt)></textarea>

	<span class="element" id="select-parser-span"><span class="edit-caption">パーサ</span>
	<select name="parser" id="select-parser">
		<@forexec_hash(ROBJ, v.parsers, begin)><option value="<@key>"<@if(art.parser eq key, ' selected')>><@val></option>
		<$end>
	</select></span>
	<@ifexec(!edit_pkey || art.draft, begin)>
	<button type="submit" name="draft" value="1" id="save-draft">下書き保存</button><span class="help" data-help="下書きは記事一覧にも表示されません。下書き記事は、テンプレートとして使用することもできます。">?</span>
	<$end>
	<button type="submit" name="edit" id="save-normal" value="1"><@if(edit_pkey, '編集内容を保存', '新規に保存')></button>
	<@ifexec(Develop, begin)>
		<input type="checkbox" class="js-switch" data-target="#-dummy-" data-save="1" id="parser-debug" name="parser_debug" value="1"><label for="parser-debug">パーサーのデバッグ</label>
	<$end>


	<!--===============================================================-->
	<input type="hidden" name="checkbox.info" value="enable">
	<input type="hidden" name="checkbox.info" value="draft">
	<input type="hidden" name="checkbox.info" value="allow_com">
	<input type="hidden" name="checkbox.info" value="allow_hcom">
	<input type="hidden" name="checkbox.info" value="ping">
	<input type="hidden" name="checkbox.info" value="auto_tb">
	<input type="hidden" name="checkbox.info" value="tw_ping">
	<input type="hidden" name="checkbox.info" value="wiki">
	<ul class="checkbox">
		<li><input type="checkbox" name="enable" value="1"<@if(art.enable, ' checked')>><label>記事を公開</label><span class="help" data-help="公開設定に関わらず、下書きは公開されません">?</span></li>
		<li><input type="checkbox" name="com_ok" value="1"<@if(art.com_ok, ' checked')>><label>コメントを受け付ける</label></li>
		<li><input type="checkbox" name="hcom_ok" value="1"<@if(art.hcom_ok, ' checked')>><label>非公開コメントを許可する</label></li>
	<@ifexec(!s.private && (art.draft || !edit_pkey), begin)>
		<@ifexec(v.sys.ping_servers_txt, begin)>
		<li><input type="checkbox" name="ping" value="1"<@if(s.ping, ' checked')>><label>更新通知Pingを送信する</label><span class="help" data-help="更新通知を送ると他の人があなたの記事を見つけやすくなります。\n【送信先】\n<@v.sys.ping_servers_txt>">?</span></li>
		<$end>
	<$end>
		<li><input type="checkbox" name="wiki" value="1" data-target="#wiki-block" class="js-switch"<@if(art.ctype || art.wiki, ' checked')>><label>wikiコンテンツにする</label>
		<input type="hidden" name="priority" value="<@art.priority>">
		<ul id="wiki-block" style="display: none">
			<li>親ノード：<select name="upnode" id="upnode-select" data-default="<@art.upnode>" data-this-pkey="<@edit_pkey>" data-url="<@Basepath><@v.blogpub_dir>contents.json">
				<option value="0">*トップ(root)</option>
			</select></li>
			<li>コンテンツkey：<input type="text" name="link_key" id="link-key" class="w240" value="<@if(art.ctype, esc(art.link_key))>" data-suggest="<@s.suggest_link_key>"></li>
		</ul>
		</li>
		<@ifexec(!art.draft && edit_pkey, begin)>
		<li><input type="checkbox" name="draft" value="1"<@if(art.draft, ' checked')>><label>この記事を下書きとして保存する</label><span class="help" data-help="初公開日時の情報も消去されます。">?</span></li>
		<$end>
		<li><a href="<@v.myself>?etc/allow_tags&amp;n=article" target="_blank">※使用可能なHTMLタグ一覧</a></li>
	</ul>

	<button type="submit" name="edit" id="save-last" value="1"><@if(edit_pkey, '編集内容を保存', '新規に保存')></button>
</form>
<@ifexec(edit_pkey, begin)>
	<ul class="checkbox">
	<li><input type="checkbox" name="post_detail" data-target="#post-detail" class="js-switch"<@if(s.post_detail, ' checked')>> <@\>
	<label>投稿の詳細情報表示</label>
		<ul id="post-detail"<@if(!s.post_detail, ' style="display: none"')>>
			<@ifexec(art.tm,begin)>
			<li>書き込み日時 <span title="<@art.tm>"><@tm_printf("%Y/%m/%d %J:%M:%S", art.tm)></span></li>
			<$end>
			<li>最終更新日時 <@tm_printf("%Y/%m/%d %J:%M:%S", art.update_tm)></li>
			<li>IP <@art.ip></li>
			<li>HOST <@art.host></li>
			<li>AGENT <@art.agent></li>
		</ul></li>
	<li><input type="checkbox" name="del_check" class="js-enable" data-target="#del-submit"><label>削除確認</label></li>
	</ul>
<form method="POST" action="<@v.myself2>" class="delete js-form-check" data-confirm="この記事を本当に削除しますか？">
	<input type="hidden" name="action" value="delete">
	<input type="hidden" name="csrf_check_key" value="<@CSRF_check_key>">
	<input type="hidden" name="delete_pkey_int_ary" value="<@edit_pkey>">
	<input type="hidden" name="title" value="<@art.title>">
	<input type="submit" name="delete" id="del-submit" value="この記事を削除する">
</form>
<$end>
</div> <!-- end of body -->
</article>


<input type="hidden" value="<@v.sys.edit_lock_time>" id="edit-lock-time">
<div style="display:none">
<span id="new-tag-title">タグを入力</span>
<span id="new-tag-msg">※階層の区切りは「<span class="mono">::</span>」です。<br>※「,」は使用できません。</span>
<span id="new-tag-append">追加</span>
<span id="new-tag-cancel">キャンセル</span>
<span id="edit-confirm">この記事を編集している人が他にいますが、編集を継続しますか？%u</span>
<span id="msg-multiline">複数行を一度に処理できません。</span>
<span id="msg-for-ie8">このブラウザではこの機能は使用できません。</span>
</div>

